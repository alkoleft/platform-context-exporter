# Активный контекст: Реализация MCP сервера

## Текущее состояние
**Режим:** PLAN → CREATIVE (готов к переходу)
**Дата:** Текущая сессия планирования
**Задача:** Реализация MCP сервера для API платформы 1С Предприятие

## Ключевые выводы планирования

### Уровень сложности: Level 3 (Intermediate Feature)
Задача требует:
- Интеграцию с MCP протоколом (JSON-RPC 2.0)
- Создание новой CLI команды
- Реализацию нечеткого поиска
- Работу со stdin/stdout

### Архитектурные решения
1. **MCP Integration Pattern:** Отдельный пакет `mcp` с четким разделением ответственности
2. **Search Strategy:** In-memory индексирование с fuzzy matching
3. **Response Formatting:** Переиспользование `MarkdownExporter` с MCP-специфичными шаблонами

### Компоненты требующие творческого подхода
1. **Архитектура MCP интеграции** - дизайн JSON-RPC обработчиков
2. **Алгоритм нечеткого поиска** - стратегия индексирования и ранжирования  
3. **Формат ответов MCP** - структура Markdown документов

## Готовые решения для реализации

### Существующие компоненты (можно переиспользовать)
- ✅ `BaseExporterLogic` - извлечение данных
- ✅ `MarkdownExporter` - форматирование в Markdown
- ✅ `PlatformContextGrabber` - загрузка данных из .hbk файлов
- ✅ DTO классы - представление данных

### Новые компоненты (требуют реализации)
- ❌ `McpServerCommand` - CLI команда для MCP режима
- ❌ `McpProtocolHandler` - обработка JSON-RPC протокола
- ❌ `McpSearchService` - сервис нечеткого поиска
- ❌ `McpResponseFormatter` - форматирование ответов для MCP

## Технические детали

### Зависимости для добавления
```gradle
implementation 'com.github.therapi:therapi-runtime-javadoc:0.15.0' // JSON-RPC
implementation 'org.apache.lucene:lucene-core:9.8.0' // Fuzzy search
```

### Файловая структура
```
src/main/java/ru/alkoleft/context/platform/
├── commands/
│   └── McpServerCommand.java          # Новый
└── mcp/                               # Новый пакет
    ├── McpProtocolHandler.java
    ├── McpSearchService.java
    ├── McpResponseFormatter.java
    └── dto/
        ├── McpRequest.java
        └── McpResponse.java
```

## Критические точки

### 1. Логирование в MCP режиме
- **Проблема:** stdout используется для JSON-RPC, логи могут нарушить протокол
- **Решение:** Перенаправить все логи в файл или stderr

### 2. Производительность поиска
- **Проблема:** Большой объем данных платформы 1С
- **Решение:** Предварительное индексирование при инициализации

### 3. Graceful shutdown
- **Проблема:** MCP сервер должен корректно завершаться
- **Решение:** Обработка сигналов завершения

## Следующие шаги
1. **CREATIVE режим** - детальное проектирование архитектуры
2. **IMPLEMENT режим** - пошаговая реализация компонентов
3. **QA режим** - тестирование и валидация

## Готовность к CREATIVE режиму: ✅
- План детально проработан
- Компоненты идентифицированы
- Архитектурные решения намечены
- Творческие задачи выделены 